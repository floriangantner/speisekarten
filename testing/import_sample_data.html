<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Read XML - File</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="Florian Gantner">
<script src="../js/jquery/jquery-3.3.1.min.js"></script>
<script src="../js/pouchdb/pouchdb-7.0.0.min.js"></script>
<script src="../js/pouchdb/pouchdb.find.js"></script>
<script src="../js/DB/DB.js"></script>
<script>

//This file turns data from xlsx into json
//real test data, no faked ones

//Using coordinates to generate geojson

//import from xml file/request
//TODO: add function to read every single file in the specified directory
$(document).ready(function(){
//View existing entries:

$("#show").on("click", function(){

  DBhist_persons.allDocs({
      include_docs: true
    }).then(function (result) {
      var docs = result.rows.map(function (row) {
        return row.doc;
      });
      for(i in docs){
          console.log(docs[i]);
          $("#temp").append(`<li>${docs[i].name}</li>`)

        }

    }).catch(function (err) {
      console.log(err);
    });

});

$("#upcvr").on("click", function(){
  var input = document.getElementById('multiupload');
  var list = document.getElementById('temp-files');

  //empty list for now...
  while (list.hasChildNodes()) {
  	list.removeChild(ul.firstChild);
  }

  //for every file...
  for (var x = 0; x < input.files.length; x++) {
  	//add to list
  	var li = document.createElement('li');
  	li.innerHTML = 'File ' + (x + 1) + ':  ' + input.files[x].name;
  	list.append(li);

  }

for(var x = 0; x < input.files.length; x++){
     $.ajax({
      type: "GET" ,
      url:  input.files[x].name ,
      dataType: "xml" ,
      success: function(xml) {
      //var xmlDoc = $.parseXML( xml );   <------------------this line
      //if single item
      //$("#temp").append(xml);

              var person = {};
      //var person = $(xml2).find('description').text();
      //console.log(person);
      //but if it's multible items then loop

      //dargestellte Person, Hauptname
      $(xml).find('lido\\:subject[lido\\:type="portrait"]').each(function(){
        //präferierter Name der Darstellung
        $(this).find('lido\\:subjectActor > lido\\:actor > lido\\:nameActorSet > lido\\:appellationValue[lido\\:pref="preferred"]').each(function(){
         $("#temp").append('<li>' + $(this).text() + '</li>');
         person.name = $(this).text();
        });
        //Array von Berufen
        //richtig in LIDO adressieren?
        person.beruf = [];
        $(this).find('lido\\:term').each(function(){
          person.beruf.push($(this).text());
        });
          //Geburts- und Sterbedatum
          person.birthdate = $(this).find('lido\\:vitalDatesActor lido\\:earliestDate').text();
          person.deathdate = $(this).find('lido\\:vitalDatesActor lido\\:latestDate').text();
      });

      //Datei-Identifikator
      //Pfad zur allerkleinsten jpeg:
          $(xml).find('lido\\:resourceSet ').each(function(){
          person.fileid = $(this).find('lido\\:resourceID[lido\\:type="local"]').text();
          person.filejpeg_small = $(this).find('lido\\:resourceRepresentation[lido\\:type="size_1"] lido\\:linkResource[lido\\:formatResource="jpg"]').text();
          });
        //Geburts- und Todesdatum
        DBaddnew(person, DBhist_persons);
      //Bild-Infos: zur API
          var img = $("<img />").attr('src', person.filejpeg_small)
              .on('load', function() {
                  if (!this.complete || typeof this.naturalWidth == "undefined" || this.naturalWidth == 0) {
                      alert('broken image!');
                  } else {
                      $("#temp").append(img);
                  }
              });

              console.log(person);
      }
  });

}

});


$("#add").on("click", function(){
//add entries to Database, create new ids

   $.ajax({
    type: "GET" ,
    url: "PT_00001_02_GF.xml" ,
    dataType: "xml" ,
    success: function(xml) {
    //var xmlDoc = $.parseXML( xml );   <------------------this line
    //if single item
    //$("#temp").append(xml);

            var person = {};
    //var person = $(xml2).find('description').text();
    //console.log(person);
    //but if it's multible items then loop

    //dargestellte Person, Hauptname
    $(xml).find('lido\\:subject[lido\\:type="portrait"]').each(function(){
      //präferierter Name der Darstellung
      $(this).find('lido\\:subjectActor > lido\\:actor > lido\\:nameActorSet > lido\\:appellationValue[lido\\:pref="preferred"]').each(function(){
       $("#temp").append('<li>' + $(this).text() + '</li>');
       person.name = $(this).text();
      });
      //Array von Berufen
      //richtig in LIDO adressieren?
      person.beruf = [];
      $(this).find('lido\\:term').each(function(){
        person.beruf.push($(this).text());
      });
        //Geburts- und Sterbedatum
        person.birthdate = $(this).find('lido\\:vitalDatesActor lido\\:earliestDate').text();
        person.deathdate = $(this).find('lido\\:vitalDatesActor lido\\:latestDate').text();
    });

    //Datei-Identifikator
    //Pfad zur allerkleinsten jpeg:
        $(xml).find('lido\\:resourceSet ').each(function(){
        person.fileid = $(this).find('lido\\:resourceID[lido\\:type="local"]').text();
        person.filejpeg_small = $(this).find('lido\\:resourceRepresentation[lido\\:type="size_1"] lido\\:linkResource[lido\\:formatResource="jpg"]').text();
        });
      //Geburts- und Todesdatum
      DBaddnew(person, DBhist_persons);
    //Bild-Infos: zur API
        var img = $("<img />").attr('src', person.filejpeg_small)
            .on('load', function() {
                if (!this.complete || typeof this.naturalWidth == "undefined" || this.naturalWidth == 0) {
                    alert('broken image!');
                } else {
                    $("#temp").append(img);
                }
            });

            console.log(person);
    }
});

});

$("#clean").on("click", function(){
//Clean view of historic persons
$("#temp").html("");

});

$("#delete").on("click", function(){
//Delete Database
//DBhist_persons.destroy().then(function () {
  // database destroyed
  //create new one
//    DBhist_persons = new PouchDB('persons_hist');
//}).catch(function (err) {
  // error occurred
//  console.log(err);
//});


  DBhist_persons.allDocs({
      include_docs: true
    }).then(function (result) {
      var docs = result.rows.map(function (row) {
        return row.doc;
      });
      for(i in docs){
          console.log(docs[i]);
          docs[i]._deleted = true;
          DBhist_persons.put(docs[i]);
          }


    }).then(function(){


    }).catch(function (err) {
      console.log(err);
    });

});

});

</script>
 </head>

<body>
<h2>XML-Datei importieren</h2>
<div>Liest Infos, also die wichtigen festgelegten Infos, aus der XML-Datei zu den Datensätzen des Dt. Museum.
Erstellt aus den Daten dann ein JSON und speichert diese in der DB ab.
Dadurch werden die unnnötigen xml-Formatierungen weggeworfen und die 20MB Xml-Daten eingespart.
 . In der Konsole logbar.</div>
 <div><p>* Dateien aus dem gleichen Ordner auswählen<form enctype="multipart/form-data">
   <input type="file" id="multiupload" name="uploadFiledd[]" multiple >
   <button type="button" id="upcvr" class="btn btn-primary">Start Upload</button>
</form></p>
<p>
<button id="show">Personen in der DB anzeigen</button>
   <button id="clean">Auswahl leeren</button>
   <button id="delete">Datenbank mit Personen löschen</button>
 </div>
</p>
 <div>
   <p>Liste der Dateien:
<ul id="temp-files" color="green"></ul>
</p><p> Liste der Personen:
 <ul id="temp" color="red"></ul>
</p>
</div>


<!--
 <form enctype="multipart/form-data">
     <input id="upload" type=file  name="files[]">
 </form>

     <textarea class="form-control" rows=35 cols=120 id="xlx_json"></textarea>
   <script>
         document.getElementById('upload').addEventListener('change', handleFileSelect, false);

     </script>
-->
</body>
</html>
